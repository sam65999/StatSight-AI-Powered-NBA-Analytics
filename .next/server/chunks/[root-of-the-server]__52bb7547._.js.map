{"version":3,"sources":["turbopack:///[project]/lib/ai-client.ts"],"sourcesContent":["/**\r\n * Unified AI Client for OpenRouter\r\n * Implements primary model with automatic fallback to secondary model\r\n * \r\n * Primary Model: mistralai/mistral-small-3.1-24b-instruct:free\r\n * Fallback Model: deepseek/deepseek-chat-v3.1:free\r\n */\r\n\r\nexport interface AIMessage {\r\n  role: 'system' | 'user' | 'assistant'\r\n  content: string\r\n}\r\n\r\nexport interface AIRequestOptions {\r\n  messages: AIMessage[]\r\n  temperature?: number\r\n  max_tokens?: number\r\n  response_format?: { type: 'json_object' }\r\n}\r\n\r\nexport interface AIResponse {\r\n  content: string\r\n  model_used: string\r\n  fallback_triggered: boolean\r\n  error?: string\r\n}\r\n\r\nexport interface AIClientConfig {\r\n  apiKey: string\r\n  siteUrl?: string\r\n  appTitle?: string\r\n}\r\n\r\nexport class AIClientError extends Error {\r\n  constructor(\r\n    message: string,\r\n    public statusCode?: number,\r\n    public isRateLimitError?: boolean,\r\n    public isTimeoutError?: boolean\r\n  ) {\r\n    super(message)\r\n    this.name = 'AIClientError'\r\n  }\r\n}\r\n\r\nexport class AIClient {\r\n  private apiKey: string\r\n  private siteUrl: string\r\n  private appTitle: string\r\n  \r\n  // Model configuration\r\n  private readonly PRIMARY_MODEL = 'mistralai/mistral-small-3.1-24b-instruct:free'\r\n  private readonly FALLBACK_MODEL = 'deepseek/deepseek-chat-v3.1:free'\r\n  private readonly OPENROUTER_URL = 'https://openrouter.ai/api/v1/chat/completions'\r\n  \r\n  // Timeout settings\r\n  private readonly REQUEST_TIMEOUT = 30000 // 30 seconds\r\n  \r\n  constructor(config: AIClientConfig) {\r\n    if (!config.apiKey) {\r\n      throw new AIClientError('OpenRouter API key is required')\r\n    }\r\n    \r\n    this.apiKey = config.apiKey\r\n    this.siteUrl = config.siteUrl || 'http://localhost:3000'\r\n    this.appTitle = config.appTitle || 'StatSight AI'\r\n  }\r\n  \r\n  /**\r\n   * Make a completion request with automatic fallback\r\n   */\r\n  async complete(options: AIRequestOptions): Promise<AIResponse> {\r\n    let lastError: AIClientError | null = null\r\n    \r\n    // Try primary model first\r\n    try {\r\n      console.log(`[AI Client] Attempting request with primary model: ${this.PRIMARY_MODEL}`)\r\n      const content = await this.makeRequest(this.PRIMARY_MODEL, options)\r\n      \r\n      return {\r\n        content,\r\n        model_used: this.PRIMARY_MODEL,\r\n        fallback_triggered: false\r\n      }\r\n    } catch (error) {\r\n      lastError = this.handleError(error)\r\n      console.error(`[AI Client] Primary model failed:`, lastError.message)\r\n      \r\n      // Don't fallback if it's not a recoverable error\r\n      if (!this.shouldFallback(lastError)) {\r\n        throw lastError\r\n      }\r\n    }\r\n    \r\n    // Try fallback model\r\n    try {\r\n      console.log(`[AI Client] Attempting request with fallback model: ${this.FALLBACK_MODEL}`)\r\n      const content = await this.makeRequest(this.FALLBACK_MODEL, options)\r\n      \r\n      return {\r\n        content,\r\n        model_used: this.FALLBACK_MODEL,\r\n        fallback_triggered: true\r\n      }\r\n    } catch (error) {\r\n      const fallbackError = this.handleError(error)\r\n      console.error(`[AI Client] Fallback model also failed:`, fallbackError.message)\r\n      \r\n      // If both models fail, throw combined error\r\n      throw new AIClientError(\r\n        `Both AI models failed. Primary: ${lastError?.message}. Fallback: ${fallbackError.message}`,\r\n        fallbackError.statusCode\r\n      )\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Make a request to OpenRouter API\r\n   */\r\n  private async makeRequest(model: string, options: AIRequestOptions): Promise<string> {\r\n    const controller = new AbortController()\r\n    const timeoutId = setTimeout(() => controller.abort(), this.REQUEST_TIMEOUT)\r\n    \r\n    try {\r\n      const response = await fetch(this.OPENROUTER_URL, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Authorization': `Bearer ${this.apiKey}`,\r\n          'Content-Type': 'application/json',\r\n          'HTTP-Referer': this.siteUrl,\r\n          'X-Title': this.appTitle,\r\n        },\r\n        body: JSON.stringify({\r\n          model,\r\n          messages: options.messages,\r\n          temperature: options.temperature ?? 0.3,\r\n          max_tokens: options.max_tokens ?? 600,\r\n          ...(options.response_format && { response_format: options.response_format })\r\n        }),\r\n        signal: controller.signal\r\n      })\r\n      \r\n      clearTimeout(timeoutId)\r\n      \r\n      // Handle non-OK responses\r\n      if (!response.ok) {\r\n        const errorText = await response.text()\r\n        let errorMessage = errorText\r\n        \r\n        try {\r\n          const errorJson = JSON.parse(errorText)\r\n          errorMessage = errorJson.error?.message || errorJson.message || errorText\r\n        } catch {\r\n          // Use raw text if JSON parse fails\r\n        }\r\n        \r\n        throw new AIClientError(\r\n          errorMessage,\r\n          response.status,\r\n          response.status === 429, // Rate limit\r\n          false\r\n        )\r\n      }\r\n      \r\n      const data = await response.json()\r\n      const content = data.choices?.[0]?.message?.content\r\n      \r\n      if (!content) {\r\n        throw new AIClientError('No content in AI response')\r\n      }\r\n      \r\n      return content\r\n      \r\n    } catch (error: any) {\r\n      clearTimeout(timeoutId)\r\n      \r\n      // Handle abort/timeout\r\n      if (error.name === 'AbortError') {\r\n        throw new AIClientError(\r\n          `Request timeout after ${this.REQUEST_TIMEOUT / 1000}s`,\r\n          408,\r\n          false,\r\n          true\r\n        )\r\n      }\r\n      \r\n      // Re-throw if already AIClientError\r\n      if (error instanceof AIClientError) {\r\n        throw error\r\n      }\r\n      \r\n      // Wrap other errors\r\n      throw new AIClientError(\r\n        error.message || 'Unknown error during AI request',\r\n        500\r\n      )\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Determine if we should attempt fallback based on error type\r\n   */\r\n  private shouldFallback(error: AIClientError): boolean {\r\n    // Fallback on rate limits, timeouts, and server errors\r\n    if (error.isRateLimitError) {\r\n      console.log('[AI Client] Rate limit detected, will attempt fallback')\r\n      return true\r\n    }\r\n    \r\n    if (error.isTimeoutError) {\r\n      console.log('[AI Client] Timeout detected, will attempt fallback')\r\n      return true\r\n    }\r\n    \r\n    if (error.statusCode && error.statusCode >= 500) {\r\n      console.log('[AI Client] Server error detected, will attempt fallback')\r\n      return true\r\n    }\r\n    \r\n    // Don't fallback on client errors (400, 401, 403, etc.)\r\n    if (error.statusCode && error.statusCode >= 400 && error.statusCode < 500) {\r\n      console.log('[AI Client] Client error detected, will NOT attempt fallback')\r\n      return false\r\n    }\r\n    \r\n    // Fallback on unknown errors\r\n    return true\r\n  }\r\n  \r\n  /**\r\n   * Convert various error types to AIClientError\r\n   */\r\n  private handleError(error: any): AIClientError {\r\n    if (error instanceof AIClientError) {\r\n      return error\r\n    }\r\n    \r\n    if (error.name === 'AbortError') {\r\n      return new AIClientError(\r\n        'Request timeout',\r\n        408,\r\n        false,\r\n        true\r\n      )\r\n    }\r\n    \r\n    return new AIClientError(\r\n      error.message || 'Unknown error',\r\n      error.statusCode || 500\r\n    )\r\n  }\r\n}\r\n\r\n/**\r\n * Create a configured AI client instance\r\n */\r\nexport function createAIClient(apiKey?: string): AIClient {\r\n  const key = apiKey || process.env.OPENROUTER_API_KEY\r\n  \r\n  if (!key) {\r\n    throw new AIClientError('OPENROUTER_API_KEY environment variable is not set')\r\n  }\r\n  \r\n  return new AIClient({\r\n    apiKey: key,\r\n    siteUrl: process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000',\r\n    appTitle: 'StatSight AI Predictions'\r\n  })\r\n}\r\n\r\n/**\r\n * Helper function to parse JSON response with fallback\r\n */\r\nexport function parseAIResponse<T>(content: string, fallback: T): T {\r\n  try {\r\n    // Try to extract JSON from response\r\n    const jsonMatch = content.match(/\\{[\\s\\S]*\\}/)\r\n    if (jsonMatch) {\r\n      return JSON.parse(jsonMatch[0])\r\n    }\r\n    \r\n    // If no JSON found, return fallback\r\n    console.warn('[AI Client] No JSON found in response, using fallback')\r\n    return fallback\r\n  } catch (error) {\r\n    console.error('[AI Client] Error parsing JSON:', error)\r\n    return fallback\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}