{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/samga/OneDrive/Desktop/AI%20Stat/with-supabase-app/lib/ai-client.ts"],"sourcesContent":["/**\r\n * Unified AI Client for OpenRouter\r\n * Implements primary model with automatic fallback to secondary model\r\n * \r\n * Primary Model: mistralai/mistral-small-3.1-24b-instruct:free\r\n * Fallback Model: deepseek/deepseek-chat-v3.1:free\r\n */\r\n\r\nexport interface AIMessage {\r\n  role: 'system' | 'user' | 'assistant'\r\n  content: string\r\n}\r\n\r\nexport interface AIRequestOptions {\r\n  messages: AIMessage[]\r\n  temperature?: number\r\n  max_tokens?: number\r\n  response_format?: { type: 'json_object' }\r\n}\r\n\r\nexport interface AIResponse {\r\n  content: string\r\n  model_used: string\r\n  fallback_triggered: boolean\r\n  error?: string\r\n}\r\n\r\nexport interface AIClientConfig {\r\n  apiKey: string\r\n  siteUrl?: string\r\n  appTitle?: string\r\n}\r\n\r\nexport class AIClientError extends Error {\r\n  constructor(\r\n    message: string,\r\n    public statusCode?: number,\r\n    public isRateLimitError?: boolean,\r\n    public isTimeoutError?: boolean\r\n  ) {\r\n    super(message)\r\n    this.name = 'AIClientError'\r\n  }\r\n}\r\n\r\nexport class AIClient {\r\n  private apiKey: string\r\n  private siteUrl: string\r\n  private appTitle: string\r\n  \r\n  // Model configuration\r\n  private readonly PRIMARY_MODEL = 'mistralai/mistral-small-3.1-24b-instruct:free'\r\n  private readonly FALLBACK_MODEL = 'deepseek/deepseek-chat-v3.1:free'\r\n  private readonly OPENROUTER_URL = 'https://openrouter.ai/api/v1/chat/completions'\r\n  \r\n  // Timeout settings\r\n  private readonly REQUEST_TIMEOUT = 30000 // 30 seconds\r\n  \r\n  constructor(config: AIClientConfig) {\r\n    if (!config.apiKey) {\r\n      throw new AIClientError('OpenRouter API key is required')\r\n    }\r\n    \r\n    this.apiKey = config.apiKey\r\n    this.siteUrl = config.siteUrl || 'http://localhost:3000'\r\n    this.appTitle = config.appTitle || 'StatSight AI'\r\n  }\r\n  \r\n  /**\r\n   * Make a completion request with automatic fallback\r\n   */\r\n  async complete(options: AIRequestOptions): Promise<AIResponse> {\r\n    let lastError: AIClientError | null = null\r\n    \r\n    // Try primary model first\r\n    try {\r\n      console.log(`[AI Client] Attempting request with primary model: ${this.PRIMARY_MODEL}`)\r\n      const content = await this.makeRequest(this.PRIMARY_MODEL, options)\r\n      \r\n      return {\r\n        content,\r\n        model_used: this.PRIMARY_MODEL,\r\n        fallback_triggered: false\r\n      }\r\n    } catch (error) {\r\n      lastError = this.handleError(error)\r\n      console.error(`[AI Client] Primary model failed:`, lastError.message)\r\n      \r\n      // Don't fallback if it's not a recoverable error\r\n      if (!this.shouldFallback(lastError)) {\r\n        throw lastError\r\n      }\r\n    }\r\n    \r\n    // Try fallback model\r\n    try {\r\n      console.log(`[AI Client] Attempting request with fallback model: ${this.FALLBACK_MODEL}`)\r\n      const content = await this.makeRequest(this.FALLBACK_MODEL, options)\r\n      \r\n      return {\r\n        content,\r\n        model_used: this.FALLBACK_MODEL,\r\n        fallback_triggered: true\r\n      }\r\n    } catch (error) {\r\n      const fallbackError = this.handleError(error)\r\n      console.error(`[AI Client] Fallback model also failed:`, fallbackError.message)\r\n      \r\n      // If both models fail, throw combined error\r\n      throw new AIClientError(\r\n        `Both AI models failed. Primary: ${lastError?.message}. Fallback: ${fallbackError.message}`,\r\n        fallbackError.statusCode\r\n      )\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Make a request to OpenRouter API\r\n   */\r\n  private async makeRequest(model: string, options: AIRequestOptions): Promise<string> {\r\n    const controller = new AbortController()\r\n    const timeoutId = setTimeout(() => controller.abort(), this.REQUEST_TIMEOUT)\r\n    \r\n    try {\r\n      const response = await fetch(this.OPENROUTER_URL, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Authorization': `Bearer ${this.apiKey}`,\r\n          'Content-Type': 'application/json',\r\n          'HTTP-Referer': this.siteUrl,\r\n          'X-Title': this.appTitle,\r\n        },\r\n        body: JSON.stringify({\r\n          model,\r\n          messages: options.messages,\r\n          temperature: options.temperature ?? 0.3,\r\n          max_tokens: options.max_tokens ?? 600,\r\n          ...(options.response_format && { response_format: options.response_format })\r\n        }),\r\n        signal: controller.signal\r\n      })\r\n      \r\n      clearTimeout(timeoutId)\r\n      \r\n      // Handle non-OK responses\r\n      if (!response.ok) {\r\n        const errorText = await response.text()\r\n        let errorMessage = errorText\r\n        \r\n        try {\r\n          const errorJson = JSON.parse(errorText)\r\n          errorMessage = errorJson.error?.message || errorJson.message || errorText\r\n        } catch {\r\n          // Use raw text if JSON parse fails\r\n        }\r\n        \r\n        throw new AIClientError(\r\n          errorMessage,\r\n          response.status,\r\n          response.status === 429, // Rate limit\r\n          false\r\n        )\r\n      }\r\n      \r\n      const data = await response.json()\r\n      const content = data.choices?.[0]?.message?.content\r\n      \r\n      if (!content) {\r\n        throw new AIClientError('No content in AI response')\r\n      }\r\n      \r\n      return content\r\n      \r\n    } catch (error: any) {\r\n      clearTimeout(timeoutId)\r\n      \r\n      // Handle abort/timeout\r\n      if (error.name === 'AbortError') {\r\n        throw new AIClientError(\r\n          `Request timeout after ${this.REQUEST_TIMEOUT / 1000}s`,\r\n          408,\r\n          false,\r\n          true\r\n        )\r\n      }\r\n      \r\n      // Re-throw if already AIClientError\r\n      if (error instanceof AIClientError) {\r\n        throw error\r\n      }\r\n      \r\n      // Wrap other errors\r\n      throw new AIClientError(\r\n        error.message || 'Unknown error during AI request',\r\n        500\r\n      )\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Determine if we should attempt fallback based on error type\r\n   */\r\n  private shouldFallback(error: AIClientError): boolean {\r\n    // Fallback on rate limits, timeouts, and server errors\r\n    if (error.isRateLimitError) {\r\n      console.log('[AI Client] Rate limit detected, will attempt fallback')\r\n      return true\r\n    }\r\n    \r\n    if (error.isTimeoutError) {\r\n      console.log('[AI Client] Timeout detected, will attempt fallback')\r\n      return true\r\n    }\r\n    \r\n    if (error.statusCode && error.statusCode >= 500) {\r\n      console.log('[AI Client] Server error detected, will attempt fallback')\r\n      return true\r\n    }\r\n    \r\n    // Don't fallback on client errors (400, 401, 403, etc.)\r\n    if (error.statusCode && error.statusCode >= 400 && error.statusCode < 500) {\r\n      console.log('[AI Client] Client error detected, will NOT attempt fallback')\r\n      return false\r\n    }\r\n    \r\n    // Fallback on unknown errors\r\n    return true\r\n  }\r\n  \r\n  /**\r\n   * Convert various error types to AIClientError\r\n   */\r\n  private handleError(error: any): AIClientError {\r\n    if (error instanceof AIClientError) {\r\n      return error\r\n    }\r\n    \r\n    if (error.name === 'AbortError') {\r\n      return new AIClientError(\r\n        'Request timeout',\r\n        408,\r\n        false,\r\n        true\r\n      )\r\n    }\r\n    \r\n    return new AIClientError(\r\n      error.message || 'Unknown error',\r\n      error.statusCode || 500\r\n    )\r\n  }\r\n}\r\n\r\n/**\r\n * Create a configured AI client instance\r\n */\r\nexport function createAIClient(apiKey?: string): AIClient {\r\n  const key = apiKey || process.env.OPENROUTER_API_KEY\r\n  \r\n  if (!key) {\r\n    throw new AIClientError('OPENROUTER_API_KEY environment variable is not set')\r\n  }\r\n  \r\n  return new AIClient({\r\n    apiKey: key,\r\n    siteUrl: process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000',\r\n    appTitle: 'StatSight AI Predictions'\r\n  })\r\n}\r\n\r\n/**\r\n * Helper function to parse JSON response with fallback\r\n */\r\nexport function parseAIResponse<T>(content: string, fallback: T): T {\r\n  try {\r\n    // Try to extract JSON from response\r\n    const jsonMatch = content.match(/\\{[\\s\\S]*\\}/)\r\n    if (jsonMatch) {\r\n      return JSON.parse(jsonMatch[0])\r\n    }\r\n    \r\n    // If no JSON found, return fallback\r\n    console.warn('[AI Client] No JSON found in response, using fallback')\r\n    return fallback\r\n  } catch (error) {\r\n    console.error('[AI Client] Error parsing JSON:', error)\r\n    return fallback\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 251, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/samga/OneDrive/Desktop/AI%20Stat/with-supabase-app/app/api/ai-followup/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { createAIClient, parseAIResponse } from '@/lib/ai-client'\r\n\r\nexport interface AIFollowUpRequest {\r\n  question: string\r\n  context: {\r\n    type: 'player-prop' | 'game-outcome' | 'player-comparison'\r\n    originalPrediction: any\r\n    stats: any\r\n    metadata?: any\r\n  }\r\n}\r\n\r\nexport interface AIFollowUpResponse {\r\n  success: boolean\r\n  answer: string\r\n  confidence?: string\r\n  modelUsed?: string\r\n  fallbackTriggered?: boolean\r\n  error?: string\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body: AIFollowUpRequest = await request.json()\r\n    const { question, context } = body\r\n\r\n    // Validate required fields\r\n    if (!question || !context || !context.type || !context.originalPrediction) {\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          error: 'Missing required fields: question, context.type, context.originalPrediction'\r\n        },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // Sanitize user question\r\n    const sanitizedQuestion = question.trim().substring(0, 500)\r\n\r\n    // Build context-specific prompt\r\n    const prompt = buildFollowUpPrompt(context, sanitizedQuestion)\r\n\r\n    // Use unified AI client with automatic fallback\r\n    try {\r\n      const aiClient = createAIClient()\r\n\r\n      const aiResponse = await aiClient.complete({\r\n        messages: [\r\n          {\r\n            role: 'system',\r\n            content: getSystemPrompt(context.type)\r\n          },\r\n          {\r\n            role: 'user',\r\n            content: prompt\r\n          }\r\n        ],\r\n        temperature: 0.3,\r\n        max_tokens: 600,\r\n      })\r\n\r\n      // Parse AI response with fallback\r\n      const parsedResponse = parseAIResponse(aiResponse.content, {\r\n        answer: aiResponse.content.substring(0, 500),\r\n        confidence: 'Medium'\r\n      })\r\n\r\n      // Log which model was used\r\n      if (aiResponse.fallback_triggered) {\r\n        console.log(`[AI Follow-up] Fallback model used: ${aiResponse.model_used}`)\r\n      }\r\n\r\n      return NextResponse.json({\r\n        success: true,\r\n        answer: parsedResponse.answer || aiResponse.content,\r\n        confidence: parsedResponse.confidence,\r\n        modelUsed: aiResponse.model_used,\r\n        fallbackTriggered: aiResponse.fallback_triggered\r\n      })\r\n    } catch (aiError: any) {\r\n      console.error('AI Client Error:', aiError)\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          error: aiError.message || 'AI service error'\r\n        },\r\n        { status: aiError.statusCode || 500 }\r\n      )\r\n    }\r\n  } catch (error) {\r\n    console.error('Error in AI follow-up route:', error)\r\n    return NextResponse.json(\r\n      {\r\n        success: false,\r\n        error: error instanceof Error ? error.message : 'Internal server error'\r\n      },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\n/**\r\n * Get system prompt based on context type\r\n */\r\nfunction getSystemPrompt(type: string): string {\r\n  const basePrompt = 'You are an expert NBA analyst providing follow-up insights and analysis.'\r\n\r\n  switch (type) {\r\n    case 'player-prop':\r\n      return `${basePrompt} You have already made a prop bet prediction and now the user is asking a follow-up question. Use the original prediction, confidence level, and player statistics to provide a detailed, consistent answer. Keep your response concise (2-4 sentences) and data-driven.`\r\n\r\n    case 'game-outcome':\r\n      return `${basePrompt} You have already predicted a game outcome and now the user is asking a follow-up question. Use the original prediction, team statistics, and key factors to provide a detailed, consistent answer. Keep your response concise (2-4 sentences) and data-driven.`\r\n\r\n    case 'player-comparison':\r\n      return `${basePrompt} You are comparing two NBA players and the user is asking a follow-up question. Use both players' statistics and performance data to provide a detailed comparison and answer. Keep your response concise (2-4 sentences) and data-driven.`\r\n\r\n    default:\r\n      return `${basePrompt} Answer the user's follow-up question using the provided context and data.`\r\n  }\r\n}\r\n\r\n/**\r\n * Build context-specific prompt for follow-up questions\r\n */\r\nfunction buildFollowUpPrompt(context: any, question: string): string {\r\n  switch (context.type) {\r\n    case 'player-prop':\r\n      return buildPlayerPropFollowUpPrompt(context, question)\r\n\r\n    case 'game-outcome':\r\n      return buildGameOutcomeFollowUpPrompt(context, question)\r\n\r\n    case 'player-comparison':\r\n      return buildPlayerComparisonFollowUpPrompt(context, question)\r\n\r\n    default:\r\n      return `Context: ${JSON.stringify(context, null, 2)}\\n\\nUser Question: ${question}\\n\\nProvide a concise, data-driven answer.`\r\n  }\r\n}\r\n\r\n/**\r\n * Build player prop follow-up prompt\r\n */\r\nfunction buildPlayerPropFollowUpPrompt(context: any, question: string): string {\r\n  const { originalPrediction, stats } = context\r\n\r\n  return `\r\nORIGINAL PREDICTION:\r\nPlayer: ${originalPrediction.playerName}\r\nProp Type: ${originalPrediction.propType}\r\nThreshold: ${originalPrediction.overUnder} ${originalPrediction.threshold}\r\nAI Prediction: ${originalPrediction.prediction}\r\nConfidence: ${originalPrediction.confidence}\r\nReasoning: ${originalPrediction.reasoning}\r\nProjected Value: ${originalPrediction.projectedValue || 'N/A'}\r\n${originalPrediction.statsUsed ? `\\nKey Stats: ${originalPrediction.statsUsed.join(', ')}` : ''}\r\n\r\nPLAYER STATISTICS:\r\n${stats ? JSON.stringify(stats, null, 2) : 'Stats not available'}\r\n\r\nUSER FOLLOW-UP QUESTION:\r\n${question}\r\n\r\nINSTRUCTIONS:\r\nBased on the original prediction and player statistics above, answer the user's follow-up question.\r\nKeep your answer concise (2-4 sentences), data-driven, and consistent with the original prediction.\r\nIf the question asks for specific numbers or games, reference the statistics provided.\r\n\r\nResponse format (JSON):\r\n{\r\n  \"answer\": \"Your concise answer here (2-4 sentences)\",\r\n  \"confidence\": \"High|Medium|Low\"\r\n}\r\n`\r\n}\r\n\r\n/**\r\n * Build game outcome follow-up prompt\r\n */\r\nfunction buildGameOutcomeFollowUpPrompt(context: any, question: string): string {\r\n  const { originalPrediction, stats } = context\r\n\r\n  return `\r\nORIGINAL PREDICTION:\r\nTeam 1: ${originalPrediction.team1}\r\nTeam 2: ${originalPrediction.team2}\r\nPredicted Winner: ${originalPrediction.winner}\r\nConfidence: ${originalPrediction.confidence}\r\nWin Probability: ${originalPrediction.winProbability || 'N/A'}%\r\nScore Prediction: ${originalPrediction.scorePrediction || 'N/A'}\r\nReasoning: ${originalPrediction.reasoning}\r\n${originalPrediction.keyFactors ? `\\nKey Factors:\\n${originalPrediction.keyFactors.map((f: string) => `- ${f}`).join('\\n')}` : ''}\r\n\r\nTEAM STATISTICS:\r\n${stats ? JSON.stringify(stats, null, 2) : 'Stats not available'}\r\n\r\nUSER FOLLOW-UP QUESTION:\r\n${question}\r\n\r\nINSTRUCTIONS:\r\nBased on the original game prediction and team statistics above, answer the user's follow-up question.\r\nKeep your answer concise (2-4 sentences), data-driven, and consistent with the original prediction.\r\nIf the question asks about specific players or matchups, use the provided statistics.\r\n\r\nResponse format (JSON):\r\n{\r\n  \"answer\": \"Your concise answer here (2-4 sentences)\",\r\n  \"confidence\": \"High|Medium|Low\"\r\n}\r\n`\r\n}\r\n\r\n/**\r\n * Build player comparison follow-up prompt\r\n */\r\nfunction buildPlayerComparisonFollowUpPrompt(context: any, question: string): string {\r\n  const { stats, metadata } = context\r\n\r\n  return `\r\nPLAYER COMPARISON CONTEXT:\r\n${metadata ? JSON.stringify(metadata, null, 2) : ''}\r\n\r\nPLAYER STATISTICS:\r\n${stats ? JSON.stringify(stats, null, 2) : 'Stats not available'}\r\n\r\nUSER FOLLOW-UP QUESTION:\r\n${question}\r\n\r\nINSTRUCTIONS:\r\nBased on the player comparison data above, answer the user's follow-up question.\r\nCompare the two players directly, highlighting differences and similarities.\r\nKeep your answer concise (2-4 sentences) and data-driven.\r\n\r\nResponse format (JSON):\r\n{\r\n  \"answer\": \"Your concise comparison answer here (2-4 sentences)\",\r\n  \"confidence\": \"High|Medium|Low\"\r\n}\r\n`\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}